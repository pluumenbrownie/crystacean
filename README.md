Crystacean is a library and cli program, which can generate different amourphous silicon dioxide structures on a substrate. The library can be used in both Rust and Python. 

# Installation
To use Crystacean, you need to install the required dependencies:
1. Clone the repository.
1. Install the Rust compiler with [Rustup](https://www.rust-lang.org/tools/install).
1. Create a python virtual environment with your tool of choice, containing the requirements in `requirements.txt`.
1. Change directory to `lattice_solver_python`.
1. Create the Python module by running
```bash
$ maturin develop --release
```
This makes it possible to use both the Python library and the cli.

# Usage

## ASE readable json formate
Crystacean can read json files containing crystal structures which have been generated by ASE. These files can be created with ASE by converting more conventional file formats like `xyz` or `vasp` to `json` using 
```bash
$ ase convert <name>.<format> <name>.json
```
Crystacean can use these files to find interface configurations and create new files with the found configurations by adding atoms at the correct locations. The file must follow a few criteria:
1. The attachment sites are marked with hydrogen atoms.
1. The attachment sites are below `z = 20.0`.

## CLI
The Crystacean cli can be accessed by activating the right python virtual environment and running
```bash
$ python cli.py <command>
```
when located in the directory of the cloned repository, or in any other locations by running
```bash
$ python /path/to/cli.py <command>
```
To see a list of available commands, run
```bash
$ python cli.py --help
```

### Quickstart
I want to find possible surface structures for the `T16.json` lattice in the `test_lattices` directory:
```bash
$ python cli.py from-file -f -d 0.1 -m 0 -j -s exports/T16_example test_lattices/T16.json example
```
This command will take the structure from `exports/T16_example` and find structures, which will be filtered by similarity within 0.1 Angstrom, and which contain no singlet points. These structures will be called `example_<number>` and will be saved in an ASE readable json format. For more information on cli arguments and options, run
```bash
$ python cli.py <command> --help
```

## Python 
Here is an example the cli quickstart worked out in Python (adapted from `cli.py`):
```python
import os
from crystacean import from_dft_json

# Make the output directory
save_to = "exports/T16_example"
os.mkdir(save_to)
# Import the lattice from the file
lattice = from_dft_json("test_lattices/T16.json", 3.5, False)
# get_intermediary creates a solver class and can be supplied with a few options
bit_lattice = lattice.get_intermediary(
    # no singlets
    max_singlets = 0,
    # use the similatiry filter, with a margin of 0.1 angstrom
    use_filter = True,
    difference_distance = 0.1,
)
# Create a list bitvectors representing valid solutions
# The solve method gets passed True to find all solutions, instead of stopping
# after finding the first one
solutions = bit_lattice.solve(True)
# Save all of the structures
for number, solution in enumerate(solutions):
    # Solutions need to be reverted back to lattices for exporting
    solved_lattice = lattice.to_solved_lattice(solution)
    # Save the files as json
    solved_lattice.export_as_ase_json(
        f"example_{number:>04}.json", save_to
    )
```
Try this example by running
```bash
python examples/python_example.py
```
in the repository root.

### Additional
The following example also shows how to use the no_rings filter in Python, and how to plot the lattices with matplotlib.
```python
import os
import matplotlib.pyplot as plt
from crystacean import from_dft_json

os.mkdir("exports/T16_example")
lattice = from_dft_json("test_lattices/T16.json", 3.5, False)
bit_lattice = lattice.get_intermediary(
    max_singlets = 0,
    use_filter = True,
    difference_distance = 0.1,
)

# To apply the no rings filter:
noloops = lattice.no_rings()
bit_lattice = bit_lattice.filtered(noloops)

solutions = bit_lattice.solve(True)
for number, solution in enumerate(solutions):
    solved_lattice = lattice.to_solved_lattice(solution)
    solved_lattice.export_as_ase_json(
        f"example_{number:>04}.json", save_to
    )

    # Structures can be plotted with matplotlib as follows
    plt.plot( *solved_lattice.points_to_plot())
    plt.plot( *solved_lattice.midpoints_to_plot(), "x")
    plt.plot( *solved_lattice.tripoints_to_plot(), "s")
    plt.plot( *solved_lattice.singlets_to_plot(), "^")
    plt.axis("equal")
    plt.show()
```
Try this example by running
```bash
python examples/python_example_more.py
```
in the repository root.

## Rust
The Python example rewritten in Rust.
```rust
use crystacean_rs::{bit_array_settings, BitArrayFilter, Lattice};

fn main() {
    let lattice = Lattice::from_dft_json("../test_lattices/T16.json".into(), 1.1, true);
    let options = bit_array_settings!(
        lattice,
        max_singlets = 0,
        solve_filter = BitArrayFilter::Flipped,
        difference_distance = 0.1
    );

    let bit_lattice = lattice.get_intermediary(options);
    let solutions = bit_lattice.solve(true, false);
    
    for (number, solution) in solutions.iter().enumerate() {
        let solved_lattice = lattice.to_solved_lattice(solution);
        solved_lattice.export_as_ase_json(
            (&format!("../exports/T16_example/example_{number:>4}.json"))
        );
    }
}
```
Try this example by running
```bash
cargo run --example readme_example -release
```
in the `lattice_solver` folder.